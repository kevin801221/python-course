## Python讀寫Excel檔案-1

### Excel簡介

Excel 是 Microsoft（微軟）為使用 Windows 和 macOS 作業系統開發的一款電子表格軟體。Excel 憑藉其直觀的介面、出色的計算功能和圖表工具，再加上成功的市場營銷，一直以來都是最為流行的個人計算機資料處理軟體。當然，Excel 也有很多競品，例如 Google Sheets、LibreOffice Calc、Numbers 等，這些競品基本上也能夠相容 Excel，至少能夠讀寫較新版本的 Excel 檔案，當然這些不是我們討論的重點。掌握用 Python 程式操作 Excel 檔案，可以讓日常辦公自動化的工作更加輕鬆愉快，而且在很多商業專案中，匯入匯出 Excel 檔案都是特別常見的功能。

Python 操作 Excel 需要三方庫的支援，如果要相容 Excel 2007 以前的版本，也就是`xls`格式的 Excel 檔案，可以使用三方庫`xlrd`和`xlwt`，前者用於讀 Excel 檔案，後者用於寫 Excel 檔案。如果使用較新版本的 Excel，即`xlsx`格式的 Excel 檔案，可以使用`openpyxl`庫，當然這個庫不僅僅可以操作Excel，還可以操作其他基於 Office Open XML 的電子表格檔案。

本章我們先講解基於`xlwt`和`xlrd`操作 Excel 檔案，大家可以先使用下面的命令安裝這兩個三方庫以及配合使用的工具模組`xlutils`。

```Bash
pip install xlwt xlrd xlutils
```

### 讀Excel檔案

例如在當前資料夾下有一個名為“阿里巴巴2020年股票資料.xls”的 Excel 檔案，如果想讀取並顯示該檔案的內容，可以透過如下所示的程式碼來完成。

```python
import xlrd

# 使用xlrd模組的open_workbook函式開啟指定Excel檔案並獲得Book物件（工作簿）
wb = xlrd.open_workbook('阿里巴巴2020年股票資料.xls')
# 透過Book物件的sheet_names方法可以獲取所有表單名稱
sheetnames = wb.sheet_names()
print(sheetnames)
# 透過指定的表單名稱獲取Sheet物件（工作表）
sheet = wb.sheet_by_name(sheetnames[0])
# 透過Sheet物件的nrows和ncols屬性獲取表單的行數和列數
print(sheet.nrows, sheet.ncols)
for row in range(sheet.nrows):
    for col in range(sheet.ncols):
        # 透過Sheet物件的cell方法獲取指定Cell物件（單元格）
        # 透過Cell物件的value屬性獲取單元格中的值
        value = sheet.cell(row, col).value
        # 對除首行外的其他行進行資料格式化處理
        if row > 0:
            # 第1列的xldate型別先轉成元組再格式化為“年月日”的格式
            if col == 0:
                # xldate_as_tuple函式的第二個引數只有0和1兩個取值
                # 其中0代表以1900-01-01為基準的日期，1代表以1904-01-01為基準的日期
                value = xlrd.xldate_as_tuple(value, 0)
                value = f'{value[0]}年{value[1]:>02d}月{value[2]:>02d}日'
            # 其他列的number型別處理成小數點後保留兩位有效數字的浮點數
            else:
                value = f'{value:.2f}'
        print(value, end='\t')
    print()
# 獲取最後一個單元格的資料型別
# 0 - 空值，1 - 字串，2 - 數字，3 - 日期，4 - 布林，5 - 錯誤
last_cell_type = sheet.cell_type(sheet.nrows - 1, sheet.ncols - 1)
print(last_cell_type)
# 獲取第一行的值（列表）
print(sheet.row_values(0))
# 獲取指定行指定列範圍的資料（列表）
# 第一個引數代表行索引，第二個和第三個引數代表列的開始（含）和結束（不含）索引
print(sheet.row_slice(3, 0, 5))
```

> **提示**：上面程式碼中使用的Excel檔案“阿里巴巴2020年股票資料.xls”可以透過後面的百度雲盤地址進行獲取。連結:https://pan.baidu.com/s/1rQujl5RQn9R7PadB2Z5g_g 提取碼:e7b4。

相信透過上面的程式碼，大家已經瞭解到瞭如何讀取一個 Excel 檔案，如果想知道更多關於`xlrd`模組的知識，可以閱讀它的[官方文件](https://xlrd.readthedocs.io/en/latest/)。

### 寫Excel檔案

寫入 Excel 檔案可以透過`xlwt` 模組的`Workbook`類建立工作簿物件，透過工作簿物件的`add_sheet`方法可以新增工作表，透過工作表物件的`write`方法可以向指定單元格中寫入資料，最後透過工作簿物件的`save`方法將工作簿寫入到指定的檔案或記憶體中。下面的程式碼實現了將5 個學生 3 門課程的考試成績寫入 Excel 檔案的操作。

```python
import random

import xlwt

student_names = ['關羽', '張飛', '趙雲', '馬超', '黃忠']
scores = [[random.randrange(50, 101) for _ in range(3)] for _ in range(5)]
# 建立工作簿物件（Workbook）
wb = xlwt.Workbook()
# 建立工作表物件（Worksheet）
sheet = wb.add_sheet('一年級二班')
# 新增表頭資料
titles = ('姓名', '語文', '數學', '英語')
for index, title in enumerate(titles):
    sheet.write(0, index, title)
# 將學生姓名和考試成績寫入單元格
for row in range(len(scores)):
    sheet.write(row + 1, 0, student_names[row])
    for col in range(len(scores[row])):
        sheet.write(row + 1, col + 1, scores[row][col])
# 儲存Excel工作簿
wb.save('考試成績表.xls')
```

### 調整單元格樣式

在寫Excel檔案時，我們還可以為單元格設定樣式，主要包括字型（Font）、對齊方式（Alignment）、邊框（Border）和背景（Background）的設定，`xlwt`對這幾項設定都封裝了對應的類來支援。要設定單元格樣式需要首先建立一個`XFStyle`物件，再透過該物件的屬性對字型、對齊方式、邊框等進行設定，例如在上面的例子中，如果希望將表頭單元格的背景色修改為黃色，可以按照如下的方式進行操作。

```python
header_style = xlwt.XFStyle()
pattern = xlwt.Pattern()
pattern.pattern = xlwt.Pattern.SOLID_PATTERN
# 0 - 黑色、1 - 白色、2 - 紅色、3 - 綠色、4 - 藍色、5 - 黃色、6 - 粉色、7 - 青色
pattern.pattern_fore_colour = 5
header_style.pattern = pattern
titles = ('姓名', '語文', '數學', '英語')
for index, title in enumerate(titles):
    sheet.write(0, index, title, header_style)
```

如果希望為表頭設定指定的字型，可以使用`Font`類並新增如下所示的程式碼。

```python
font = xlwt.Font()
# 字型名稱
font.name = '華文楷體'
# 字型大小（20是基準單位，18表示18px）
font.height = 20 * 18
# 是否使用粗體
font.bold = True
# 是否使用斜體
font.italic = False
# 字型顏色
font.colour_index = 1
header_style.font = font
```

> **注意**：上面程式碼中指定的字型名（`font.name`）應當是本地系統有的字型，例如在我的電腦上有名為“華文楷體”的字型。

如果希望表頭垂直居中對齊，可以使用下面的程式碼進行設定。

```python
align = xlwt.Alignment()
# 垂直方向的對齊方式
align.vert = xlwt.Alignment.VERT_CENTER
# 水平方向的對齊方式
align.horz = xlwt.Alignment.HORZ_CENTER
header_style.alignment = align
```

如果希望給表頭加上黃色的虛線邊框，可以使用下面的程式碼來設定。

```python
borders = xlwt.Borders()
props = (
    ('top', 'top_colour'), ('right', 'right_colour'),
    ('bottom', 'bottom_colour'), ('left', 'left_colour')
)
# 透過迴圈對四個方向的邊框樣式及顏色進行設定
for position, color in props:
    # 使用setattr內建函式動態給物件指定的屬性賦值
    setattr(borders, position, xlwt.Borders.DASHED)
    setattr(borders, color, 5)
header_style.borders = borders
```

如果要調整單元格的寬度（列寬）和表頭的高度（行高），可以按照下面的程式碼進行操作。

```python
# 設定行高為40px
sheet.row(0).set_style(xlwt.easyxf(f'font:height {20 * 40}'))
titles = ('姓名', '語文', '數學', '英語')
for index, title in enumerate(titles):
    # 設定列寬為200px
    sheet.col(index).width = 20 * 200
    # 設定單元格的資料和樣式
    sheet.write(0, index, title, header_style)
```

### 公式計算

對於前面開啟的“阿里巴巴2020年股票資料.xls”檔案，如果要統計全年收盤價（Close欄位）的平均值以及全年交易量（Volume欄位）的總和，可以使用Excel的公式計算即可。我們可以先使用`xlrd`讀取Excel資料夾，然後透過`xlutils`三方庫提供的`copy`函式將讀取到的Excel檔案轉成`Workbook`物件進行寫操作，在呼叫`write`方法時，可以將一個`Formula`物件寫入單元格。

實現公式計算的程式碼如下所示。

```python
import xlrd
import xlwt
from xlutils.copy import copy

wb_for_read = xlrd.open_workbook('阿里巴巴2020年股票資料.xls')
sheet1 = wb_for_read.sheet_by_index(0)
nrows, ncols = sheet1.nrows, sheet1.ncols
wb_for_write = copy(wb_for_read)
sheet2 = wb_for_write.get_sheet(0)
sheet2.write(nrows, 4, xlwt.Formula(f'average(E2:E{nrows})'))
sheet2.write(nrows, 6, xlwt.Formula(f'sum(G2:G{nrows})'))
wb_for_write.save('阿里巴巴2020年股票資料彙總.xls')
```

> **說明**：上面的程式碼有一些小瑕疵，有興趣的讀者可以自行探索並思考如何解決。

###  總結

掌握了 Python 程式操作 Excel 的方法，可以解決日常辦公中很多繁瑣的處理 Excel 電子表格工作，最常見就是將多個資料格式相同的 Excel 檔案合併到一個檔案以及從多個 Excel 檔案或表單中提取指定的資料。當然，如果要對錶格資料進行處理，使用 Python 資料分析神器之一的 pandas 庫可能更為方便。
