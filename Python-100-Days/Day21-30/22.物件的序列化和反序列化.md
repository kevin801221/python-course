## 物件的序列化和反序列化

###JSON概述

透過上面的講解，我們已經知道如何將文字資料和二進位制資料儲存到檔案中，那麼這裡還有一個問題，如果希望把一個列表或者一個字典中的資料儲存到檔案中又該怎麼做呢？在Python中，我們可以將程式中的資料以JSON格式進行儲存。JSON是“JavaScript Object Notation”的縮寫，它本來是JavaScript語言中建立物件的一種字面量語法，現在已經被廣泛的應用於跨語言跨平臺的資料交換。使用JSON的原因非常簡單，因為它結構緊湊而且是純文字，任何作業系統和程式語言都能處理純文字，這就是**實現跨語言跨平臺資料交換**的前提條件。目前JSON基本上已經取代了XML（可擴充套件標記語言）作為**異構系統間交換資料的事實標準**。可以在[JSON的官方網站](https://www.json.org/json-zh.html)找到更多關於JSON的知識，這個網站還提供了每種語言處理JSON資料格式可以使用的工具或三方庫。

```JavaScript
{
    name: "Kevin",
    age: 40,
    friends: ["王大錘", "白元芳"],
    cars: [
        {"brand": "BMW", "max_speed": 240},
        {"brand": "Benz", "max_speed": 280},
        {"brand": "Audi", "max_speed": 280}
    ]
}
```

上面是JSON的一個簡單例子，大家可能已經注意到了，它跟Python中的字典非常類似而且支援巢狀結構，就好比Python字典中的值可以是另一個字典。我們可以嘗試把下面的程式碼輸入瀏覽器的控制檯（對於Chrome瀏覽器，可以透過“更多工具”選單找到“開發者工具”子選單，就可以開啟瀏覽器的控制檯），瀏覽器的控制檯提供了一個執行JavaScript程式碼的互動式環境（類似於Python的互動式環境），下面的程式碼會幫我們建立出一個JavaScript的物件，我們將其賦值給名為`obj`的變數。

```JavaScript
let obj = {
    name: "Kevin",
    age: 40,
    friends: ["王大錘", "白元芳"],
    cars: [
        {"brand": "BMW", "max_speed": 240},
        {"brand": "Benz", "max_speed": 280},
        {"brand": "Audi", "max_speed": 280}
    ]
}
```

<img src="res/20210820143803.png" alt="image-20210820143756353" width="80%">

上面的`obj`就是JavaScript中的一個物件，我們可以透過`obj.name`或`obj["name"]`兩種方式獲取到`name`對應的值，如下圖所示。可以注意到，`obj["name"]`這種獲取資料的方式跟Python字典透過鍵獲取值的索引操作是完全一致的，而Python中也透過名為`json`的模組提供了字典與JSON雙向轉換的支援。

<img src="res/20210820144411.png" width="85%">

我們在JSON中使用的資料型別（JavaScript資料型別）和Python中的資料型別也是很容易找到對應關係的，大家可以看看下面的兩張表。

表1：JavaScript資料型別（值）對應的Python資料型別（值）

| JSON         | Python       |
| ------------ | ------------ |
| `object`      |`dict`|
| `array`      |`list`|
| `string`     | `str`        |
| `number ` |`int` / `float`|
| `number` (real)   |`float`|
| `boolean` (`true` / `false`) | `bool` (`True` / `False`) |
| `null`       | `None`       |

表2：Python資料型別（值）對應的JavaScript資料型別（值）

| Python                      | JSON                         |
| --------------------------- | ---------------------------- |
| `dict`                      | `object`                     |
| `list` / `tuple`            | `array`                      |
| `str`                       | `string`                     |
| `int` / `float`             | `number`                     |
| `bool` （`True` / `False`） | `boolean` (`true` / `false`) |
| `None`                      | `null`                       |

### 讀寫JSON格式的資料

在Python中，如果要將字典處理成JSON格式（以字串形式存在），可以使用`json`模組的`dumps`函式，程式碼如下所示。

```python
import json

my_dict = {
    'name': 'Kevin',
    'age': 40,
    'friends': ['王大錘', '白元芳'],
    'cars': [
        {'brand': 'BMW', 'max_speed': 240},
        {'brand': 'Audi', 'max_speed': 280},
        {'brand': 'Benz', 'max_speed': 280}
    ]
}
print(json.dumps(my_dict))
```

執行上面的程式碼，輸出如下所示，可以注意到中文字元都是用Unicode編碼顯示的。

```JSON
{"name": "\u9a86\u660a", "age": 40, "friends": ["\u738b\u5927\u9524", "\u767d\u5143\u82b3"], "cars": [{"brand": "BMW", "max_speed": 240}, {"brand": "Audi", "max_speed": 280}, {"brand": "Benz", "max_speed": 280}]}
```

如果要將字典處理成JSON格式並寫入文字檔案，只需要將`dumps`函式換成`dump`函式並傳入檔案物件即可，程式碼如下所示。

```python
import json

my_dict = {
    'name': 'Kevin',
    'age': 40,
    'friends': ['王大錘', '白元芳'],
    'cars': [
        {'brand': 'BMW', 'max_speed': 240},
        {'brand': 'Audi', 'max_speed': 280},
        {'brand': 'Benz', 'max_speed': 280}
    ]
}
with open('data.json', 'w') as file:
    json.dump(my_dict, file)
```

執行上面的程式碼，會建立`data.json`檔案，檔案的內容跟上面程式碼的輸出是一樣的。

`json`模組有四個比較重要的函式，分別是：

- `dump` - 將Python物件按照JSON格式序列化到檔案中
- `dumps` - 將Python物件處理成JSON格式的字串
- `load` - 將檔案中的JSON資料反序列化成物件
- `loads` - 將字串的內容反序列化成Python物件

這裡出現了兩個概念，一個叫序列化，一個叫反序列化，[維基百科](https://zh.wikipedia.org/)上的解釋是：“序列化（serialization）在電腦科學的資料處理中，是指將資料結構或物件狀態轉換為可以儲存或傳輸的形式，這樣在需要的時候能夠恢復到原先的狀態，而且透過序列化的資料重新獲取位元組時，可以利用這些位元組來產生原始物件的副本（複製）。與這個過程相反的動作，即從一系列位元組中提取資料結構的操作，就是反序列化（deserialization）”。

我們可以透過下面的程式碼，讀取上面建立的`data.json`檔案，將JSON格式的資料還原成Python中的字典。

```python
import json

with open('data.json', 'r') as file:
    my_dict = json.load(file)
    print(type(my_dict))
    print(my_dict)
```

### 包管理工具pip

Python標準庫中的`json`模組在資料序列化和反序列化時效能並不是非常理想，為了解決這個問題，可以使用三方庫`ujson`來替換`json`。所謂三方庫，是指非公司內部開發和使用的，也不是來自於官方標準庫的Python模組，這些模組通常由其他公司、組織或個人開發，所以被稱為三方庫。雖然Python語言的標準庫雖然已經提供了諸多模組來方便我們的開發，但是對於一個強大的語言來說，它的生態圈一定也是非常繁榮的。

之前安裝Python直譯器時，預設情況下已經勾選了安裝pip，大家可以在命令提示符或終端中透過`pip --version`來確定是否已經擁有了pip。pip是Python的包管理工具，透過pip可以查詢、安裝、解除安裝、更新Python的三方庫或工具，macOS和Linux系統應該使用pip3。例如要安裝替代`json`模組的`ujson`，可以使用下面的命令。

```Bash
pip install ujson
```

在預設情況下，pip會訪問`https://pypi.org/simple/`來獲得三方庫相關的資料，但是國內訪問這個網站的速度並不是十分理想，因此國內使用者可以使用豆瓣網提供的映象來替代這個預設的下載源，操作如下所示。

```Bash
pip install ujson
```

可以透過`pip search`命令根據名字查詢需要的三方庫，可以透過`pip list`命令來檢視已經安裝過的三方庫。如果想更新某個三方庫，可以使用`pip install -U`或`pip install --upgrade`；如果要刪除某個三方庫，可以使用`pip uninstall`命令。

搜尋`ujson`三方庫。

```Bash
pip search ujson

micropython-cpython-ujson (0.2)  - MicroPython module ujson ported to CPython
pycopy-cpython-ujson (0.2)       - Pycopy module ujson ported to CPython
ujson (3.0.0)                    - Ultra fast JSON encoder and decoder for Python
ujson-bedframe (1.33.0)          - Ultra fast JSON encoder and decoder for Python
ujson-segfault (2.1.57)          - Ultra fast JSON encoder and decoder for Python. Continuing 
                                   development.
ujson-ia (2.1.1)                 - Ultra fast JSON encoder and decoder for Python (Internet 
                                   Archive fork)
ujson-x (1.37)                   - Ultra fast JSON encoder and decoder for Python
ujson-x-legacy (1.35.1)          - Ultra fast JSON encoder and decoder for Python
drf_ujson (1.2)                  - Django Rest Framework UJSON Renderer
drf-ujson2 (1.6.1)               - Django Rest Framework UJSON Renderer
ujsonDB (0.1.0)                  - A lightweight and simple database using ujson.
fast-json (0.3.2)                - Combines best parts of json and ujson for fast serialization
decimal-monkeypatch (0.4.3)      - Python 2 performance patches: decimal to cdecimal, json to 
                                   ujson for psycopg2
```

檢視已經安裝的三方庫。

```Bash
pip list

Package                       Version
----------------------------- ----------
aiohttp                       3.5.4
alipay                        0.7.4
altgraph                      0.16.1
amqp                          2.4.2
...							  ...
```

更新`ujson`三方庫。

```Bash
pip install -U ujson
```

刪除`ujson`三方庫。

```Bash
pip uninstall -y ujson
```

> **提示**：如果要更新`pip`自身，對於macOS系統來說，可以使用命令`pip install -U pip`。在Windows系統上，可以將命令替換為`python -m pip install -U --user pip`。

### 使用網路API獲取資料

如果想在我們自己的程式中顯示天氣、路況、航班等資訊，這些資訊我們自己沒有能力提供，所以必須使用網路資料服務。目前絕大多數的網路資料服務（或稱之為網路API）都是基於[HTTP](https://zh.wikipedia.org/wiki/%E8%B6%85%E6%96%87%E6%9C%AC%E4%BC%A0%E8%BE%93%E5%8D%8F%E8%AE%AE)或HTTPS提供JSON格式的資料，我們可以透過Python程式傳送HTTP請求給指定的URL（統一資源定位符），這個URL就是所謂的網路API，如果請求成功，它會返回HTTP響應，而HTTP響應的訊息體中就有我們需要的JSON格式的資料。關於HTTP的相關知識，可以看看阮一峰的[《HTTP協議入門》](http://www.ruanyifeng.com/blog/2016/08/http.html)一文。

國內有很多提供網路API介面的網站，例如[聚合資料](https://www.juhe.cn/)、[阿凡達資料](http://www.avatardata.cn/)等，這些網站上有免費的和付費的資料介面，國外的[{API}Search](http://apis.io/)網站也提供了類似的功能，有興趣的可以自行研究。下面的例子演示瞭如何使用[`requests`](http://docs.python-requests.org/zh_CN/latest/)庫（基於HTTP進行網路資源訪問的三方庫）訪問網路API獲取國內新聞並顯示新聞標題和連結。在這個例子中，我們使用了名為[天行資料](https://www.tianapi.com/)的網站提供的國內新聞資料介面，其中的APIKey需要自己到網站上註冊申請。在天行資料網站註冊賬號後會自動分配APIKey，但是要訪問介面獲取資料，需要繫結驗證郵箱或手機，然後還要申請需要使用的介面，如下圖所示。

<img src="res/20210820151134.png" alt="image-20210820151134034" width="100%">

Python透過URL接入網路，我們推薦大家使用`requests`三方庫，它簡單且強大，但需要自行安裝。

```Bash
pip install requests
```

獲取國內新聞並顯示新聞標題和連結。

```python
import requests

resp = requests.get('http://api.tianapi.com/guonei/?key=APIKey&num=10')
if resp.status_code == 200:
    data_model = resp.json()
    for news in data_model['newslist']:
        print(news['title'])
        print(news['url'])
        print('-' * 60)
```

上面的程式碼透過`requests`模組的`get`函式向天行資料的國內新聞介面發起了一次請求，如果請求過程沒有出現問題，`get`函式會返回一個`Response`物件，透過該物件的`status_code`屬性表示HTTP響應狀態碼，如果不理解沒關係，你只需要關注它的值，如果值等於`200`或者其他`2`字頭的值，那麼我們的請求是成功的。透過`Response`物件的`json()`方法可以將返回的JSON格式的資料直接處理成Python字典，非常方便。天行資料國內新聞介面返回的JSON格式的資料（部分）如下圖所示。

<img src="res/20210820154455.png" width="100%">

> **提示**：上面程式碼中的APIKey需要換成自己在天行資料網站申請的APIKey。天行資料網站上還有提供了很多非常有意思的API介面，例如：垃圾分類、周公解夢等，大家可以仿照上面的程式碼來呼叫這些介面。每個介面都有對應的介面文件，文件中有關於如何使用介面的詳細說明。

###  總結

Python中實現序列化和反序列化除了使用`json`模組之外，還可以使用`pickle`和`shelve`模組，但是這兩個模組是使用特有的序列化協議來序列化資料，因此序列化後的資料只能被Python識別，關於這兩個模組的相關知識，有興趣的讀者可以自己查詢網路上的資料。處理JSON格式的資料很顯然是程式設計師必須掌握的一項技能，因為不管是訪問網路API介面還是提供網路API介面給他人使用，都需要具備處理JSON格式資料的相關知識。

