## Python傳送郵件和簡訊

在前面的課程中，我們已經教會大家如何用 Python 程式自動的生成 Excel、Word、PDF 文件，接下來我們還可以更進一步，就是透過郵件將生成好的文件傳送給指定的收件人，然後用簡訊告知對方我們發出了郵件。這些事情利用 Python 程式也可以輕鬆愉快的解決。

### 傳送電子郵件

在即時通訊軟體如此發達的今天，電子郵件仍然是網際網路上使用最為廣泛的應用之一，公司嚮應聘者發出錄用通知、網站向使用者傳送一個啟用賬號的連結、銀行向客戶推廣它們的理財產品等幾乎都是透過電子郵件來完成的，而這些任務應該都是由程式自動完成的。

我們可以用HTTP（超文字傳輸協議）來訪問網站資源，HTTP 是一個應用級協議，它建立在 TCP（傳輸控制協議）之上，TCP 為很多應用級協議提供了可靠的資料傳輸服務。如果要傳送電子郵件，需要使用 SMTP（簡單郵件傳輸協議），它也是建立在 TCP 之上的應用級協議，規定了郵件的傳送者如何跟郵件伺服器進行通訊的細節。Python 透過名為`smtplib`的模組將這些操作簡化成了`SMTP_SSL`物件，透過該物件的`login`和`send_mail`方法，就能夠完成傳送郵件的操作。

我們先嚐試一下傳送一封極為簡單的郵件，該郵件不包含附件、圖片以及其他超文字內容。傳送郵件首先需要接入郵件伺服器，我們可以自己架設郵件伺服器，這件事情對新手並不友好，但是我們可以選擇使用第三方提供的郵件服務。例如，我在<www.126.com>已經註冊了賬號，登入成功之後，就可以在設定中開啟 SMTP 服務，這樣就相當於獲得了郵件伺服器，具體的操作如下所示。

<img src="res/20210820190307.png" alt="image-20210820190306861" width="85%">

<img src="res/20210820190816.png" style="zoom:55%;">

用手機掃碼上面的二維碼可以透過傳送簡訊的方式來獲取授權碼，簡訊傳送成功後，點選“我已傳送”就可以獲得授權碼。授權碼需要妥善保管，因為一旦洩露就會被其他人冒用你的身份來傳送郵件。接下來，我們就可以編寫傳送郵件的程式碼了，如下所示。

```python
import smtplib
from email.header import Header
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText

# 建立郵件主體物件
email = MIMEMultipart()
# 設定發件人、收件人和主題
email['From'] = 'xxxxxxxxx@126.com'
email['To'] = 'yyyyyy@qq.com;zzzzzz@1000phone.com'
email['Subject'] = Header('上半年工作情況彙報', 'utf-8')
# 新增郵件正文內容
content = """據德國媒體報道，當地時間9日，德國火車司機工會成員進行了投票，
定於當地時間10日起進行全國性罷工，貨運交通方面的罷工已於當地時間10日19時開始。
此後，從11日凌晨2時到13日凌晨2時，德國全國範圍內的客運和鐵路基礎設施將進行48小時的罷工。"""
email.attach(MIMEText(content, 'plain', 'utf-8'))

# 建立SMTP_SSL物件（連線郵件伺服器）
smtp_obj = smtplib.SMTP_SSL('smtp.126.com', 465)
# 透過使用者名稱和授權碼進行登入
smtp_obj.login('xxxxxxxxx@126.com', '郵件伺服器的授權碼')
# 傳送郵件（發件人、收件人、郵件內容（字串））
smtp_obj.sendmail(
    'xxxxxxxxx@126.com',
    ['yyyyyy@qq.com', 'zzzzzz@1000phone.com'],
    email.as_string()
)
```

如果要傳送帶有附件的郵件，只需要將附件的內容處理成 BASE64 編碼，那麼它就和普通的文字內容幾乎沒有什麼區別。BASE64 是一種基於 64 個可列印字元來表示二進位制資料的表示方法，常用於某些需要表示、傳輸、儲存二進位制資料的場合，電子郵件就是其中之一。對這種編碼方式不理解的同學，推薦閱讀[《Base64筆記》](http://www.ruanyifeng.com/blog/2008/06/base64.html)一文。在之前的內容中，我們也提到過，Python 標準庫的`base64`模組提供了對 BASE64 編解碼的支援。

下面的程式碼演示瞭如何傳送帶附件的郵件。

```python
import smtplib
from email.header import Header
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
from urllib.parse import quote

# 建立郵件主體物件
email = MIMEMultipart()
# 設定發件人、收件人和主題
email['From'] = 'xxxxxxxxx@126.com'
email['To'] = 'zzzzzzzz@1000phone.com'
email['Subject'] = Header('請查收離職證明檔案', 'utf-8')
# 新增郵件正文內容（帶HTML標籤排版的內容）
content = """<p>親愛的前同事：</p>
<p>你需要的離職證明在附件中，請查收！</p>
<br>
<p>祝，好！</p>
<hr>
<p>孫美麗 即日</p>"""
email.attach(MIMEText(content, 'html', 'utf-8'))
# 讀取作為附件的檔案
with open(f'resources/王大錘離職證明.docx', 'rb') as file:
    attachment = MIMEText(file.read(), 'base64', 'utf-8')
    # 指定內容型別
    attachment['content-type'] = 'application/octet-stream'
    # 將中文檔名處理成百分號編碼
    filename = quote('王大錘離職證明.docx')
    # 指定如何處置內容
    attachment['content-disposition'] = f'attachment; filename="{filename}"'

# 建立SMTP_SSL物件（連線郵件伺服器）
smtp_obj = smtplib.SMTP_SSL('smtp.126.com', 465)
# 透過使用者名稱和授權碼進行登入
smtp_obj.login('xxxxxxxxx@126.com', '郵件伺服器的授權碼')
# 傳送郵件（發件人、收件人、郵件內容（字串））
smtp_obj.sendmail(
    'xxxxxxxxx@126.com',
    'zzzzzzzz@1000phone.com',
    email.as_string()
)
```

為了方便大家用 Python 實現郵件傳送，我將上面的程式碼封裝成了函式，使用的時候大家只需要調整郵件伺服器域名、埠、使用者名稱和授權碼就可以了。

```python
import smtplib
from email.header import Header
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
from urllib.parse import quote

# 郵件伺服器域名（自行修改）
EMAIL_HOST = 'smtp.126.com'
# 郵件服務埠（通常是465）
EMAIL_PORT = 465
# 登入郵件伺服器的賬號（自行修改）
EMAIL_USER = 'xxxxxxxxx@126.com'
# 開通SMTP服務的授權碼（自行修改）
EMAIL_AUTH = '郵件伺服器的授權碼'


def send_email(*, from_user, to_users, subject='', content='', filenames=[]):
    """傳送郵件
    
    :param from_user: 發件人
    :param to_users: 收件人，多個收件人用英文分號進行分隔
    :param subject: 郵件的主題
    :param content: 郵件正文內容
    :param filenames: 附件要傳送的檔案路徑
    """
    email = MIMEMultipart()
    email['From'] = from_user
    email['To'] = to_users
    email['Subject'] = subject

    message = MIMEText(content, 'plain', 'utf-8')
    email.attach(message)
    for filename in filenames:
        with open(filename, 'rb') as file:
            pos = filename.rfind('/')
            display_filename = filename[pos + 1:] if pos >= 0 else filename
            display_filename = quote(display_filename)
            attachment = MIMEText(file.read(), 'base64', 'utf-8')
            attachment['content-type'] = 'application/octet-stream'
            attachment['content-disposition'] = f'attachment; filename="{display_filename}"'
            email.attach(attachment)

    smtp = smtplib.SMTP_SSL(EMAIL_HOST, EMAIL_PORT)
    smtp.login(EMAIL_USER, EMAIL_AUTH)
    smtp.sendmail(from_user, to_users.split(';'), email.as_string())
```

### 傳送簡訊

傳送簡訊也是專案中常見的功能，網站的註冊碼、驗證碼、營銷資訊基本上都是透過簡訊來傳送給使用者的。傳送簡訊需要三方平臺的支援，下面我們以[螺絲帽平臺](https://luosimao.com/)為例，為大家介紹如何用 Python 程式傳送簡訊。註冊賬號和購買簡訊服務的細節我們不在這裡進行贅述，大家可以諮詢平臺的客服。

<img src="res/20210820194421.png" style="zoom:35%;">

接下來，我們可以透過`requests`庫向平臺提供的簡訊閘道器發起一個 HTTP 請求，透過將接收簡訊的手機號和簡訊內容作為引數，就可以傳送簡訊，程式碼如下所示。

```python
import random

import requests


def send_message_by_luosimao(tel, message):
    """傳送簡訊（呼叫螺絲帽簡訊閘道器）"""
    resp = requests.post(
        url='http://sms-api.luosimao.com/v1/send.json',
        auth=('api', 'key-註冊成功後平臺分配的KEY'),
        data={
            'mobile': tel,
            'message': message
        },
        timeout=10,
        verify=False
    )
    return resp.json()


def gen_mobile_code(length=6):
    """生成指定長度的手機驗證碼"""
    return ''.join(random.choices('0123456789', k=length))


def main():
    code = gen_mobile_code()
    message = f'您的簡訊驗證碼是{code}，打死也不能告訴別人喲！【Python小課】'
    print(send_message_by_luosimao('13500112233', message))


if __name__ == '__main__':
    main()
```

上面請求螺絲帽的簡訊閘道器`http://sms-api.luosimao.com/v1/send.json`會返回JSON格式的資料，如果返回`{'error': 0, 'msg': 'OK'}`就說明簡訊已經傳送成功了，如果`error`的值不是`0`，可以透過檢視官方的[開發文件](https://luosimao.com/docs/api/)瞭解到底哪個環節出了問題。螺絲帽平臺常見的錯誤型別如下圖所示。

<img src="res/20210820195505.png" style="zoom:50%;">

目前，大多數簡訊平臺都會要求簡訊內容必須附上簽名，下圖是我在螺絲帽平臺配置的簡訊簽名“【Python小課】”。有些涉及到敏感內容的簡訊，還需要提前配置簡訊模板，有興趣的讀者可以自行研究。一般情況下，平臺為了防範簡訊被盜用，還會要求設定“IP 白名單”，不清楚如何配置的可以諮詢平臺客服。

<img src="res/20210820194653.png" style="zoom:35%;">

當然國內的簡訊平臺很多，讀者可以根據自己的需要進行選擇（通常會考慮費用預算、簡訊達到率、使用的難易程度等指標），如果需要在商業專案中使用簡訊服務建議購買簡訊平臺提供的套餐服務。

### 總結

其實，傳送郵件和傳送簡訊一樣，也可以透過呼叫三方服務來完成，在實際的商業專案中，建議自己架設郵件伺服器或購買三方服務來傳送郵件，這個才是比較靠譜的選擇。
